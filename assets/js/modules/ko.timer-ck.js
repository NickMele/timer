// set up some global sockets
app.modules.ko.sockets={getTimers:"timer:get:list",setCurrentTimer:"timer:set:current_timer",startTimer:"timer:start",pauseTimer:"timer:pause",resetTimer:"timer:reset",saveTimer:"timer:save",removeTimer:"timer:remove"};app.modules.ko.Timer=function(e){var t=this;t.sockets=app.modules.ko.sockets;t.data={_id:ko.observable(""),name:ko.observable(""),timerLength:ko.observable(0),timeElapsed:ko.observable(0),state:ko.observable(""),timeStarted:ko.observable("")};t.computedData={hours:null,minutes:null,seconds:null};t.trigger={startTimer:null,pauseTimer:null,resetTimer:null};t.soundModule=document.getElementById("audio-handle");t.counter=null;t.timerSubscription=null;t.computedData.hours=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/3600);e<10&&(e="0"+e);return e});t.computedData.minutes=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/60%60);e<10&&(e="0"+e);return e});t.computedData.seconds=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())%60);e<10&&(e="0"+e);return e});t.init=function(){if(typeof e!="undefined"){t.data._id(e.data._id);t.data.name(e.data.name);t.data.timerLength(e.data.timerLength);t.data.timeElapsed(e.data.timeElapsed);t.data.state(e.data.state);t.data.timeStarted(e.data.timeStarted)}if(t.data.timeStarted()){var n=(new Date(e.data.timeStarted)).getTime(),r=(new Date(e.currentDateTime)).getTime(),i=Math.floor((r-n)/1e3);t.data.timeElapsed(t.data.timeElapsed()+i);t.data.timeElapsed()>=t.data.timerLength()?t.resetTimer():t.startTimer()}};t.timerCountdown=function(){t.data.timeElapsed(t.data.timeElapsed()+1)};t.trigger={startTimer:function(){t.startTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.startTimer,e,t.startTimer)},pauseTimer:function(){t.pauseTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.pauseTimer,e,t.pauseTimer)},resetTimer:function(){t.resetTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.resetTimer,e,t.resetTimer)}};t.startTimer=function(){t.soundModule.load();t.timerSubscription=t.data.timeElapsed.subscribe(function(){if(t.data.timeElapsed()>t.data.timerLength()){t.soundModule.play();t.trigger.resetTimer()}});clearInterval(t.counter);t.data.timeStarted(new Date);t.data.state("started");t.counter=setInterval(t.timerCountdown,1e3)};t.pauseTimer=function(){t.data.timeStarted("");t.data.state("paused");clearInterval(t.counter);t.timerSubscription.dispose()};t.resetTimer=function(){t.data.timeElapsed(0);t.data.timeStarted("");clearInterval(t.counter);t.data.state("stopped");t.timerSubscription.dispose()};t.getServerReadyData=function(){return ko.toJS(t.data)};t.getTimers=function(){app.modules.socket.emit(t.sockets.getTimers,t.setTimers)};t.setTimers=function(e){t.data.timers(e.data)};t.init()};app.modules.ko.Editor=function(e){var t=this;typeof e=="undefined"&&(e={});t.data={_id:ko.observable(e._id||""),name:ko.observable(e.name||""),timerLength:ko.observable(e.timerLength||"")};t.hours=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()/3600);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(parseInt(e),t.minutes(),t.seconds()))},owner:t});t.minutes=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()/60%60);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(t.hours(),parseInt(e),t.seconds()))},owner:t});t.seconds=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()%60);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(t.hours(),t.minutes(),parseInt(e)))},owner:t});t.reverserCalculateTime=function(e,t,n){typeof e=="undefined"&&(e=0);typeof t=="undefined"&&(t=0);typeof n=="undefined"&&(n=0);var r=e*3600+t*60+n;return parseInt(r)};t.incrementTime=function(e,n,r,i){var s={hours:t.hours,minutes:t.minutes,seconds:t.seconds},o=i.keyCode,u;u=s[e]();n=="up"||o==38?s[e](u+1):(n=="down"||o==40)&&s[e](u-1)}};app.modules.ko.TimerListViewModel=function(){"use strict";var e=this;e.sockets=app.modules.ko.sockets;e.elements={timer:{$timerEditControls:$(".timer-edit-controls"),$timerControls:$(".timer-controls"),$timerStart:$(".timer-start"),$timerPause:$(".timer-pause"),$timerReset:$(".timer-reset"),$timerZone:$(".timer-zone")}};e.state={editing:ko.observable(!1),mainMenuOpen:ko.observable(!1)};e.data={currentTimer:ko.observable(),timers:ko.observableArray([]),editor:ko.observable("")};e.setupSocketListeners=function(){app.modules.socket.on(e.sockets.getTimers,e.setTimers);app.modules.socket.on(e.sockets.setCurrentTimer,function(t){e.setTimers(t);e.data.currentTimer(t.currentTimerIndex)});app.modules.socket.on(e.sockets.startTimer,function(){e.data.timers()[e.data.currentTimer()].startTimer()});app.modules.socket.on(e.sockets.pauseTimer,function(){e.data.timers()[e.data.currentTimer()].pauseTimer()});app.modules.socket.on(e.sockets.resetTimer,function(){e.data.timers()[e.data.currentTimer()].resetTimer()})};e.createNewTimer=function(){e.state.editing(!0);e.data.editor(new app.modules.ko.Editor);e.state.mainMenuOpen(!1);$(".timer-form-name").focus()};e.editTimer=function(){e.state.editing(!0);e.data.timers()[e.data.currentTimer()].data.state()=="started"&&e.data.timers()[e.data.currentTimer()].pauseTimer();e.data.editor(new app.modules.ko.Editor(ko.toJS(e.data.timers()[e.data.currentTimer()].data)))};e.saveTimer=function(){var t=ko.toJS(e.data.editor().data);app.modules.socket.emit(e.sockets.saveTimer,t,function(t){if(!t.error){e.state.editing(!1);e.getTimers()}else console.log(t.error)})};e.cancelEdit=function(){e.state.editing(!1);e.data.editor({})};e.removeTimer=function(t){confirm("Are you sure you want to remove this timer?")&&app.modules.socket.emit(e.sockets.removeTimer,t.data._id(),function(t){t.error==null?e.setTimers(t):console.log("no error!")})};e.fullscreenMode=function(){e.elements.timer.$timerZone.toggleClass("fullscreen");return!0};e.toggleMainMenu=function(){e.state.mainMenuOpen(!e.state.mainMenuOpen())};e.getTimers=function(){app.modules.socket.emit(e.sockets.getTimers,e.setTimers)};e.setTimers=function(t){var n=$.map(t.data,function(e){var n={data:e,currentDateTime:t.currentDateTime};return new app.modules.ko.Timer(n)});e.data.timers(n)};e.setCurrentTimer=function(t){app.modules.socket.emit(e.sockets.setCurrentTimer,t,function(t){e.setTimers(t);e.state.mainMenuOpen(!1);e.data.currentTimer(t.currentTimerIndex)})};e.init=function(){e.setupSocketListeners();e.getTimers();e.setCurrentTimer(0)}};$(window).on("load",function(){"use strict";app.modules.socket=io.connect();app.modules.socket.emit("ready");app.viewModel=new app.modules.ko.TimerListViewModel;ko.applyBindings(app.viewModel);app.viewModel.init();$(window).trigger("ko.binded")});