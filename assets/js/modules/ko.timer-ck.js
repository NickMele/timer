// set up some global sockets
app.modules.ko.sockets={getTimers:"timer:get:list",setCurrentTimer:"timer:set:current_timer",startTimer:"timer:start",pauseTimer:"timer:pause",resetTimer:"timer:reset",saveTimer:"timer:save",removeTimer:"timer:remove"};app.modules.ko.Timer=function(e){var t=this;typeof e=="undefined"&&(e={});t.sockets=app.modules.ko.sockets;t.data={_id:ko.observable(e._id),name:ko.observable(e.name),timerLength:ko.observable(e.timerLength),timeElapsed:ko.observable(e.timeElapsed),state:ko.observable(e.state)};t.computedData={hours:null,minutes:null,seconds:null};t.counter=null;t.computedData.hours=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/3600);e<10&&(e="0"+e);return e});t.computedData.minutes=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/60%60);e<10&&(e="0"+e);return e});t.computedData.seconds=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())%60);e<10&&(e="0"+e);return e});t.timerCountdown=function(){t.data.timeElapsed(t.data.timeElapsed()+1);if(t.data.timeElapsed()>t.data.timerLength()){t.resetTimer();return}};t.startTimer=function(){clearInterval(t.counter);t.counter=setInterval(t.timerCountdown,1e3);t.data.state("started");var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.startTimer,e)};t.pauseTimer=function(){clearInterval(t.counter);t.data.state("paused");var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.pauseTimer,e)};t.resetTimer=function(){clearInterval(t.counter);t.data.timeElapsed(0);t.data.state("stopped");var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.resetTimer,e)};t.muteTimer=function(){};t.getServerReadyData=function(){return ko.toJS(t.data)}};app.modules.ko.Editor=function(e){var t=this;typeof e=="undefined"&&(e={});t._id=ko.observable(e._id||"");t.name=ko.observable(e.name||"");t.timerLength=ko.observable(e.timerLength||"");t.hours=ko.computed({read:function(){var e=Math.floor(t.timerLength()/3600);e===0&&(e="");return e},write:function(e){t.timerLength(t.reverserCalculateTime(parseInt(e),t.minutes(),t.seconds()))},owner:t});t.minutes=ko.computed({read:function(){var e=Math.floor(t.timerLength()/60%60);e===0&&(e="");return e},write:function(e){t.timerLength(t.reverserCalculateTime(t.hours(),parseInt(e),t.seconds()))},owner:t});t.seconds=ko.computed({read:function(){var e=Math.floor(t.timerLength()%60);e===0&&(e="");return e},write:function(e){t.timerLength(t.reverserCalculateTime(t.hours(),t.minutes(),parseInt(e)))},owner:t});t.reverserCalculateTime=function(e,t,n){typeof e=="undefined"&&(e=0);typeof t=="undefined"&&(t=0);typeof n=="undefined"&&(n=0);var r=e*3600+t*60+n;return parseInt(r)};t.incrementTime=function(e,n,r,i){var s={hours:t.hours,minutes:t.minutes,seconds:t.seconds},o;o=s[e]();n=="up"?s[e](o+1):n=="down"&&s[e](o-1)}};app.modules.ko.TimerListViewModel=function(){"use strict";var e=this;e.sockets=app.modules.ko.sockets;e.elements={timer:{$timerEditControls:$(".timer-edit-controls"),$timerControls:$(".timer-controls"),$timerStart:$(".timer-start"),$timerPause:$(".timer-pause"),$timerReset:$(".timer-reset")}};e.state={timerZoneVisible:ko.observable(!1),editingCurrentTimer:ko.observable(!1)};e.data={currentTimer:ko.observable(new app.modules.ko.Timer),timers:ko.observableArray([]),stagedTimer:ko.observable(""),editor:ko.observable("")};e.state.editorTitle=ko.computed(function(){return e.state.editingCurrentTimer()?"Edit timer":"New timer"});e.state.editorSaveButton=ko.computed(function(){return e.state.editingCurrentTimer()?"Save changes":"Create"});e.setupSocketListeners=function(){e.socket.on(e.sockets.getTimers,e.setTimers);e.socket.on(e.sockets.setCurrentTimer,function(t){e.data.currentTimer(new app.modules.ko.Timer(t))})};e.setCurrentTimer=function(t){t=ko.toJS(t.data);app.modules.socket.emit(e.sockets.setCurrentTimer,t,function(t){e.data.currentTimer(new app.modules.ko.Timer(t.data));e.state.timerZoneVisible(!0)})};e.createNewTimer=function(){e.data.editor(new app.modules.ko.Editor);e.data.stagedTimer({})};e.editTimer=function(){e.data.currentTimer().data.state()=="started"&&e.data.currentTimer().pauseTimer();e.data.editor(new app.modules.ko.Editor(ko.toJS(e.data.currentTimer().data)));e.state.editingCurrentTimer(!0)};e.saveTimer=function(){var t=ko.toJS(e.data.editor);delete t.hours;delete t.minutes;delete t.seconds;app.modules.socket.emit(e.sockets.saveTimer,t,function(t){if(t.timer){$("#timer-editor").modal("hide");e.getTimers();var n=new app.modules.ko.Timer(t.timer);e.data.currentTimer(n)}else console.log(t.err)})};e.removeTimer=function(t){app.modules.socket.emit(e.sockets.removeTimer,t.data._id(),function(t){t.error==null?e.setTimers(t):console.log("no error!")})};e.getTimers=function(){app.modules.socket.emit(e.sockets.getTimers,e.setTimers)};e.setTimers=function(t){var n=$.map(t.data,function(e){return new app.modules.ko.Timer(e)});e.data.timers(n)};e.init=function(){e.getTimers()}};$(window).on("load",function(){"use strict";app.modules.socket=io.connect();app.modules.socket.emit("ready");app.viewModel=new app.modules.ko.TimerListViewModel;ko.applyBindings(app.viewModel);app.viewModel.init();$(window).trigger("ko.binded")});