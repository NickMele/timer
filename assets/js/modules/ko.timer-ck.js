// set up some global sockets
app.modules.ko.sockets={getTimers:"timer:get:list",setCurrentTimer:"timer:set:current_timer",startTimer:"timer:start",pauseTimer:"timer:pause",resetTimer:"timer:reset",saveTimer:"timer:save",removeTimer:"timer:remove"};app.modules.ko.Timer=function(e){var t=this;t.sockets=app.modules.ko.sockets;t.data={_id:ko.observable(""),name:ko.observable(""),timerLength:ko.observable(0),timeElapsed:ko.observable(0),state:ko.observable(""),timeStarted:ko.observable("")};t.computedData={hours:null,minutes:null,seconds:null};t.trigger={startTimer:null,pauseTimer:null,resetTimer:null};t.counter=null;t.computedData.hours=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/3600);e<10&&(e="0"+e);return e});t.computedData.minutes=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())/60%60);e<10&&(e="0"+e);return e});t.computedData.seconds=ko.computed(function(){var e=Math.floor((t.data.timerLength()-t.data.timeElapsed())%60);e<10&&(e="0"+e);return e});t.init=function(){if(typeof e!="undefined"){t.data._id(e.data._id);t.data.name(e.data.name);t.data.timerLength(e.data.timerLength);t.data.timeElapsed(e.data.timeElapsed);t.data.state(e.data.state);t.data.timeStarted(e.data.timeStarted)}if(t.data.timeStarted()){var n=(new Date(e.data.timeStarted)).getTime(),r=(new Date(e.currentDateTime)).getTime(),i=Math.floor((r-n)/1e3);t.data.timeElapsed(t.data.timeElapsed()+i);if(t.data.timeElapsed()>=t.data.timerLength()){console.log("better not");t.resetTimer()}else t.startTimer()}};t.timerCountdown=function(){t.data.timeElapsed(t.data.timeElapsed()+1);if(t.data.timeElapsed()>=t.data.timerLength()){document.getElementById("audio-handle").play();clearInterval(t.counter);setTimeout(t.trigger.resetTimer,5e3)}else t.data.timeElapsed()>t.data.timerLength()-5&&$(".timer-clock span, .timer-name").addClass("final-countdown")};t.trigger={startTimer:function(){t.startTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.startTimer,e,t.startTimer)},pauseTimer:function(){t.pauseTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.pauseTimer,e,t.pauseTimer)},resetTimer:function(){t.resetTimer();var e=t.getServerReadyData();app.modules.socket.emit(t.sockets.resetTimer,e,t.resetTimer)}};t.startTimer=function(){clearInterval(t.counter);t.data.timeStarted(new Date);t.data.state("started");t.counter=setInterval(t.timerCountdown,1e3)};t.pauseTimer=function(){t.data.timeStarted("");t.data.state("paused");clearInterval(t.counter)};t.resetTimer=function(){t.data.timeElapsed(0);t.data.timeStarted("");clearInterval(t.counter);$(".timer-clock span, .timer-name").removeClass("final-countdown");t.data.state("stopped")};t.muteTimer=function(){};t.getServerReadyData=function(){return ko.toJS(t.data)};t.getTimers=function(){app.modules.socket.emit(t.sockets.getTimers,t.setTimers)};t.setTimers=function(e){t.data.timers(e.data)};t.init()};app.modules.ko.Editor=function(e){var t=this;typeof e=="undefined"&&(e={});t.data={_id:ko.observable(e._id||""),name:ko.observable(e.name||""),timerLength:ko.observable(e.timerLength||"")};t.hours=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()/3600);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(parseInt(e),t.minutes(),t.seconds()))},owner:t});t.minutes=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()/60%60);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(t.hours(),parseInt(e),t.seconds()))},owner:t});t.seconds=ko.computed({read:function(){var e=Math.floor(t.data.timerLength()%60);e===0&&(e="");return e},write:function(e){t.data.timerLength(t.reverserCalculateTime(t.hours(),t.minutes(),parseInt(e)))},owner:t});t.reverserCalculateTime=function(e,t,n){typeof e=="undefined"&&(e=0);typeof t=="undefined"&&(t=0);typeof n=="undefined"&&(n=0);var r=e*3600+t*60+n;return parseInt(r)};t.incrementTime=function(e,n,r,i){var s={hours:t.hours,minutes:t.minutes,seconds:t.seconds},o;o=s[e]();n=="up"?s[e](o+1):n=="down"&&s[e](o-1)}};app.modules.ko.TimerListViewModel=function(){"use strict";var e=this;e.sockets=app.modules.ko.sockets;e.elements={timer:{$timerEditControls:$(".timer-edit-controls"),$timerControls:$(".timer-controls"),$timerStart:$(".timer-start"),$timerPause:$(".timer-pause"),$timerReset:$(".timer-reset"),$timerZone:$(".timer-zone")}};e.state={editingCurrentTimer:ko.observable(!1)};e.data={currentTimer:ko.observable(new app.modules.ko.Timer),timers:ko.observableArray([]),stagedTimer:ko.observable(""),editor:ko.observable("")};e.state.editorTitle=ko.computed(function(){return e.state.editingCurrentTimer()?"Edit timer":"New timer"});e.state.editorSaveButton=ko.computed(function(){return e.state.editingCurrentTimer()?"Save changes":"Create"});e.setupSocketListeners=function(){app.modules.socket.on(e.sockets.getTimers,e.setTimers);app.modules.socket.on(e.sockets.setCurrentTimer,function(t){console.log("heard",t);e.data.currentTimer(new app.modules.ko.Timer(t))});app.modules.socket.on(e.sockets.startTimer,function(){e.data.currentTimer().startTimer()});app.modules.socket.on(e.sockets.pauseTimer,function(){e.data.currentTimer().pauseTimer()});app.modules.socket.on(e.sockets.resetTimer,function(){e.data.currentTimer().resetTimer()})};e.createNewTimer=function(){e.data.editor(new app.modules.ko.Editor);e.data.stagedTimer({})};e.editTimer=function(){e.data.currentTimer().data.state()=="started"&&e.data.currentTimer().pauseTimer();e.data.editor(new app.modules.ko.Editor(ko.toJS(e.data.currentTimer().data)));e.state.editingCurrentTimer(!0)};e.saveTimer=function(){var t=ko.toJS(e.data.editor().data);app.modules.socket.emit(e.sockets.saveTimer,t,function(t){if(!t.error){$("#timer-editor").modal("hide");e.getTimers();e.setCurrentTimer(t.data)}else console.log(t.error)})};e.removeTimer=function(t){app.modules.socket.emit(e.sockets.removeTimer,t.data._id(),function(t){t.error==null?e.setTimers(t):console.log("no error!")})};e.fullscreenMode=function(){e.elements.timer.$timerZone.toggleClass("fullscreen")};e.getTimers=function(){app.modules.socket.emit(e.sockets.getTimers,e.setTimers)};e.setTimers=function(t){var n=$.map(t.data,function(e){return new app.modules.ko.Timer({data:e})});e.data.timers(n)};e.setCurrentTimer=function(t){var t=ko.toJS(t.data);app.modules.socket.emit(e.sockets.setCurrentTimer,t,function(t){e.data.currentTimer(new app.modules.ko.Timer(t))})};e.init=function(){e.setupSocketListeners();e.getTimers()}};$(window).on("load",function(){"use strict";app.modules.socket=io.connect();app.modules.socket.emit("ready");app.viewModel=new app.modules.ko.TimerListViewModel;ko.applyBindings(app.viewModel);app.viewModel.init();$(window).trigger("ko.binded")});